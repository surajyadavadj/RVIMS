#include "oled.h"
#include "i2c.h"


#define OLED_ADDR 0x3C


static void oled_cmd(uint8_t cmd)
{
    i2c_write_reg(OLED_ADDR, 0x00, cmd);
}

static void oled_data(uint8_t data)
{
    i2c_write_reg(OLED_ADDR, 0x40, data);
}


void oled_init(void)
{
    oled_cmd(0xAE);        // display off
    oled_cmd(0x20); oled_cmd(0x00); // horizontal addressing
    oled_cmd(0xB0);
    oled_cmd(0xC8);
    oled_cmd(0x00);
    oled_cmd(0x10);
    oled_cmd(0x40);
    oled_cmd(0x81); oled_cmd(0x7F);
    oled_cmd(0xA1);
    oled_cmd(0xA6);
    oled_cmd(0xA8); oled_cmd(0x3F);
    oled_cmd(0xD3); oled_cmd(0x00);
    oled_cmd(0xD5); oled_cmd(0x80);
    oled_cmd(0xD9); oled_cmd(0xF1);
    oled_cmd(0xDA); oled_cmd(0x12);
    oled_cmd(0xDB); oled_cmd(0x40);
    oled_cmd(0x8D); oled_cmd(0x14);
    oled_cmd(0xAF);        // display on
}

// CURSOR 
void oled_set_cursor(uint8_t page, uint8_t col)
{
    oled_cmd(0xB0 + page);
    oled_cmd(0x00 + (col & 0x0F));
    oled_cmd(0x10 + (col >> 4));
}

// CLEAR 
void oled_clear(void)
{
    for (uint8_t p = 0; p < 8; p++)
    {
        oled_set_cursor(p, 0);
        for (uint8_t c = 0; c < 128; c++)
            oled_data(0x00);
    }
}

/* ASCII 32 (space) se start */
static const uint8_t font5x7[][5] =
{
/* SPACE (32) */
{0x00,0x00,0x00,0x00,0x00},

/* ! */
{0x00,0x00,0x5F,0x00,0x00},

/* " */
{0x00,0x07,0x00,0x07,0x00},

/* # */
{0x14,0x7F,0x14,0x7F,0x14},

/* $ */
{0x24,0x2A,0x7F,0x2A,0x12},

/* % */
{0x23,0x13,0x08,0x64,0x62},

/* & */
{0x36,0x49,0x55,0x22,0x50},

/* ' */
{0x00,0x05,0x03,0x00,0x00},

/* ( */
{0x00,0x1C,0x22,0x41,0x00},

/* ) */
{0x00,0x41,0x22,0x1C,0x00},

/* * */
{0x14,0x08,0x3E,0x08,0x14},

/* + */
{0x08,0x08,0x3E,0x08,0x08},

/* , */
{0x00,0x50,0x30,0x00,0x00},

/* - */
{0x08,0x08,0x08,0x08,0x08},

/* . */
{0x00,0x60,0x60,0x00,0x00},

/* / */
{0x20,0x10,0x08,0x04,0x02},


/* 0–9 */
{0x3E,0x51,0x49,0x45,0x3E}, // 0
{0x00,0x42,0x7F,0x40,0x00}, // 1
{0x42,0x61,0x51,0x49,0x46}, // 2
{0x21,0x41,0x45,0x4B,0x31}, // 3
{0x18,0x14,0x12,0x7F,0x10}, // 4
{0x27,0x45,0x45,0x45,0x39}, // 5
{0x3C,0x4A,0x49,0x49,0x30}, // 6
{0x01,0x71,0x09,0x05,0x03}, // 7
{0x36,0x49,0x49,0x49,0x36}, // 8
{0x06,0x49,0x49,0x29,0x1E}, // 9

/* A–Z */
{0x7E,0x11,0x11,0x11,0x7E}, // A
{0x7F,0x49,0x49,0x49,0x36}, // B
{0x3E,0x41,0x41,0x41,0x22}, // C
{0x7F,0x41,0x41,0x22,0x1C}, // D
{0x7F,0x49,0x49,0x49,0x41}, // E
{0x7F,0x09,0x09,0x09,0x01}, // F
{0x3E,0x41,0x49,0x49,0x7A}, // G
{0x7F,0x08,0x08,0x08,0x7F}, // H  
{0x00,0x41,0x7F,0x41,0x00}, // I
{0x20,0x40,0x41,0x3F,0x01}, // J
{0x7F,0x08,0x14,0x22,0x41}, // K
{0x7F,0x40,0x40,0x40,0x40}, // L
{0x7F,0x02,0x04,0x02,0x7F}, // M
{0x7F,0x04,0x08,0x10,0x7F}, // N
{0x3E,0x41,0x41,0x41,0x3E}, // O
//{0x3E,0x41,0x41,0x41,0x3E}, // O
{0x7F,0x09,0x09,0x09,0x06}, // P
{0x3E,0x41,0x51,0x21,0x5E}, // Q
{0x7F,0x09,0x19,0x29,0x46}, // R
{0x46,0x49,0x49,0x49,0x31}, // S
{0x01,0x01,0x7F,0x01,0x01}, // T
{0x3F,0x40,0x40,0x40,0x3F}, // U
{0x1F,0x20,0x40,0x20,0x1F}, // V
{0x3F,0x40,0x38,0x40,0x3F}, // W
{0x63,0x14,0x08,0x14,0x63}, // X
{0x07,0x08,0x70,0x08,0x07}, // Y
{0x61,0x51,0x49,0x45,0x43}, // Z
};


// TEXT 
void oled_write_char(char c)
{
    // Allow only SPACE, 0-9, A-Z
    if (c == ' ')
    {
        for (int i = 0; i < 5; i++)
            oled_data(0x00);
        oled_data(0x00);
        return;
    }

    if (c >= '0' && c <= '9')
        c = c - '0' + 16;   // digits start
    else if (c >= 'A' && c <= 'Z')
        c = c - 'A' + 26;   // letters start
    else
        return; 

    for (int i = 0; i < 5; i++)
        oled_data(font5x7[c][i]);

    oled_data(0x00);
}




void oled_write_string(const char *s)
{
    while (*s)
        oled_write_char(*s++);
}
